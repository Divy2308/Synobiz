<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Management Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Custom Styles */
        body {
            background-color: #eef5f9;
            background-image: linear-gradient(5deg, #5587baad, #72809100);
        }
        .container-fluid {
            width: 85%;
            margin-right: auto;
            
        }
        .card {
            border: 0;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.41), 0 2px 4px -2px rgba(0, 0, 0, 0.388);
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.552), 0 4px 6px -4px rgba(0, 0, 0, 0.497);
        }
        .stat-card.selected {
            border: 2px solid var(--bs-primary);
        }
        .icon-bg {
            padding: 0.75rem;
            border-radius: 0.5rem;
        }
        .table {
            vertical-align: middle;
        }
        .nav-tabs .nav-link {
            border: 0;
            border-bottom: 2px solid transparent;
            color: var(--bs-secondary-color);
        }
        .nav-tabs .nav-link.active {
            border-bottom-color: var(--bs-primary);
            color: var(--bs-primary);
            background-color: transparent;
        }
        .modal-content {
            border-radius: 1rem;
            border: 0;
        }
        .badge {
            font-size: 0.75em;
            font-weight: 600;
        }
    </style>
    
</head>
<body>
<div id="navbar-placeholder"></div>

{% include 'sidebar.html' %}
    <div class="container-fluid p-3 p-md-4">
        <header class="mb-4">
            <h1 class="h3 fw-bold text-dark">Ticket Management Dashboard</h1>
            <p class="text-secondary">Monitor and manage all your support tickets in one place</p>
        </header>

        <div id="stat-cards-container" class="row g-4 mb-4">
            </div>

        <main>
            <div id="dashboard-view">
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="card p-3 p-md-4 h-100">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h5 class="fw-bold">Weekly Ticket Trends</h5>
                                    <p class="text-secondary small">Last 7 days performance</p>
                                </div>
                                <span class="badge bg-success-subtle text-success-emphasis">+12.5%</span>
                            </div>
                            <div style="height: 250px;">
                                <canvas id="weeklyTrendsChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card p-3 p-md-4 h-100">
                            <h5 class="fw-bold mb-3">Priority Distribution</h5>
                             <div class="mx-auto" style="height: 200px; position: relative;">
                                <canvas id="priorityChart"></canvas>
                            </div>
                            <div id="priority-legend" class="mt-3"></div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div id="status-overview-container" class="card p-3 p-md-4">
                             </div>
                    </div>
                </div>
            </div>

            <div id="table-view" class="d-none">
                 <div class="card p-3 p-md-4">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-3">
                         <h4 class="fw-bold">Ticket Details</h4>
                         <div class="d-flex align-items-center gap-2 mt-3 mt-md-0">
                            <div class="input-group">
                               <input type="text" class="form-control" placeholder="Search...">
                               <span class="input-group-text">
                                   <i data-lucide="search" class="icon-sm"></i>
                               </span>
                            </div>
                            <button class="btn btn-light">
                                <i data-lucide="download" class="icon-sm"></i>
                            </button>
                            <button id="back-to-dashboard-btn" class="btn btn-primary">Back to Dashboard</button>
                         </div>
                    </div>
                    <nav>
                        <div class="nav nav-tabs" id="ticket-tabs" role="tablist">
                            </div>
                    </nav>
                    <div class="table-responsive mt-3">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th scope="col">TICKET #</th>
                                    <th scope="col">CUSTOMER NAME</th>
                                    <th scope="col">TASK NAME</th>
                                    <th scope="col">PRIORITY</th>
                                    <th scope="col">SMART ACTIONS</th>
                                    <th scope="col">EDIT</th>
                                </tr>
                            </thead>
                            <tbody id="ticket-table-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal fade" id="aiActionModal" tabindex="-1" aria-labelledby="aiActionModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0">
            <h1 class="modal-title fs-5 fw-semibold" id="aiActionModalLabel">AI Assistant for Ticket <span class="text-primary" id="modal-ticket-id"></span></h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body p-4">
              <p class="small text-secondary mb-1 fw-medium">Task:</p>
              <p id="modal-ticket-task" class="p-3 bg-light rounded-3"></p>
              <div id="modal-action-buttons" class="d-grid gap-2 d-md-flex mb-3">
                </div>
              <div class="p-3 bg-light rounded-3" style="min-height: 150px;">
                  <div id="ai-response-content">Select an action above to get started...</div>
                  <div id="ai-loading-spinner" class="d-none text-center p-5">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                      <p class="mt-2 text-secondary">Generating response...</p>
                  </div>
              </div>
          </div>
        </div>
      </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0rPoDcSZeG3D9GagdcR4PZCrKZyBOpODiYmIWwYyYMSHtnz0W_Zsv/Jir" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- DATA & CONFIG ---
        // Receive data from Flask backend
        const allTickets = {{ tickets | tojson }}; // This line fetches data from Flask
        
        const statusConfig = {
            Open: { icon: 'file-text', color: 'primary' },
            In_Progress: { icon: 'clock', color: 'warning' },
            Confirmed: { icon: 'check-circle', color: 'success' },
            Cancelled: { icon: 'x-circle', color: 'danger' },
        };
        
        const priorityConfig = {
            High: { color: 'danger' },
            Medium: { color: 'warning' },
            Low: { color: 'success' },
        };
        
        // --- ELEMENTS ---
        const dashboardView = document.getElementById('dashboard-view');
        const tableView = document.getElementById('table-view');
        const statCardsContainer = document.getElementById('stat-cards-container');
        const ticketTableBody = document.getElementById('ticket-table-body');
        const ticketTabsContainer = document.getElementById('ticket-tabs');
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
        const aiModalElement = document.getElementById('aiActionModal');
        const aiModal = new bootstrap.Modal(aiModalElement);

        // --- STATE & RENDER FUNCTIONS ---
        const calculateStatusCounts = () => {
            const counts = { Open: 0, In_Progress: 0, Confirmed: 0, Cancelled: 0 };
            allTickets.forEach(ticket => { // Use allTickets instead of mockTickets
                if (ticket.status in counts) {
                    counts[ticket.status]++;
                } else {
                    // Handle unexpected statuses gracefully
                    console.warn(`Unexpected ticket status: ${ticket.status}. Add it to statusConfig if needed.`);
                }
            });
            return counts;
        };

        const calculatePriorityCounts = () => {
            const counts = { High: 0, Medium: 0, Low: 0 };
            allTickets.forEach(ticket => { // Use allTickets instead of mockTickets
                if (ticket.priority in counts) {
                    counts[ticket.priority]++;
                } else {
                    console.warn(`Unexpected ticket priority: ${ticket.priority}. Add it to priorityConfig if needed.`);
                }
            });
            return counts;
        };


        const renderStatCards = () => {
            const counts = calculateStatusCounts();
            statCardsContainer.innerHTML = '';
            for (const [status, count] of Object.entries(counts)) {
                const config = statusConfig[status];
                statCardsContainer.innerHTML += `
                    <div class="col-md-6 col-lg-3">
                        <div class="card stat-card p-3" data-status-filter="${status}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="text-secondary mb-1">${status}</p>
                                    <p class="h3 fw-bold mb-0">${count}</p>
                                </div>
                                <div class="icon-bg bg-${config.color}-subtle">
                                    <i data-lucide="${config.icon}" class="text-${config.color}"></i>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }
            lucide.createIcons(); // Re-render icons
        };
        
        const renderStatusOverview = () => {
            const counts = calculateStatusCounts();
            const total = allTickets.length; // Use allTickets instead of mockTickets
            let content = `<h5 class="fw-bold mb-4">Status Overview</h5>`;
            for (const [status, count] of Object.entries(counts)) {
                const config = statusConfig[status];
                const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;
                content += `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                           <span class="small fw-medium text-secondary">${status}</span>
                           <span class="small fw-semibold">${count} (${percentage}%)</span>
                        </div>
                        <div class="progress" role="progressbar" style="height: 8px;">
                            <div class="progress-bar bg-${config.color}" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }
            document.getElementById('status-overview-container').innerHTML = content;
        };
        
        const renderTicketTable = (filter) => {
            const ticketsToRender = filter ? allTickets.filter(t => t.status === filter) : allTickets; // Use allTickets
            ticketTableBody.innerHTML = '';
            if (ticketsToRender.length === 0) {
                ticketTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-secondary p-5">No tickets found for this status.</td></tr>';
                return;
            }
            ticketsToRender.forEach(ticket => {
                const priority = priorityConfig[ticket.priority];
                const editUrl = `/tickets/edit_ticket/${ticket.id}`; // *** NEW: Construct the edit URL
                
                ticketTableBody.innerHTML += `
                    <tr>
                        <td class="fw-bold text-primary">#${ticket.ticket_number}</td>
                        <td>${ticket.customer}</td>
                        <td class="text-truncate" style="max-width: 300px;">${ticket.task}</td>
                        <td><span class="badge bg-${priority.color}-subtle text-${priority.color}-emphasis">${ticket.priority}</span></td>
                        <td><button class="btn btn-sm btn-outline-primary ai-assist-btn" data-ticket-id="${ticket.id}"><i data-lucide="sparkles" class="me-1" style="width:14px; height:14px;"></i>AI Assist</button></td>
                        
                        <td>
                           <a href="${editUrl}" class="btn btn-sm btn-outline-secondary">
                               <i data-lucide="edit" style="width:16px; height:16px;"></i> Edit
                           </a>
                        </td>
                    </tr>
                `;
            });
            lucide.createIcons();
        };
        
        const renderTicketTabs = (activeFilter) => {
            const counts = calculateStatusCounts();
            ticketTabsContainer.innerHTML = '';
             for (const [status, count] of Object.entries(counts)) {
                 const isActive = status === activeFilter;
                 ticketTabsContainer.innerHTML += `
                    <button class="nav-link ${isActive ? 'active' : ''}" data-status-filter="${status}" type="button">
                        ${status} <span class="badge rounded-pill bg-secondary-subtle text-secondary-emphasis">${count}</span>
                    </button>
                 `;
             }
        };

        // --- EVENT LISTENERS ---
        statCardsContainer.addEventListener('click', (e) => {
            const card = e.target.closest('.stat-card');
            if (card) {
                const filter = card.dataset.statusFilter;
                
                // Update UI state
                document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                dashboardView.classList.add('d-none');
                tableView.classList.remove('d-none');
                
                // Render content
                renderTicketTable(filter);
                renderTicketTabs(filter);
            }
        });

        backToDashboardBtn.addEventListener('click', () => {
            tableView.classList.add('d-none');
            dashboardView.classList.remove('d-none');
            document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('selected'));
        });
        
        ticketTabsContainer.addEventListener('click', (e) => {
            const tab = e.target.closest('.nav-link');
            if(tab) {
                const filter = tab.dataset.statusFilter;
                renderTicketTable(filter);
                // Update active tab state
                document.querySelectorAll('#ticket-tabs .nav-link').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
            }
        });
        
        ticketTableBody.addEventListener('click', (e) => {
            const btn = e.target.closest('.ai-assist-btn');
            if (btn) {
                const ticketId = btn.dataset.ticketId;
                const ticket = allTickets.find(t => String(t.id) === String(ticketId)); // Fix: compare as strings
                if (ticket) {
                    // Populate modal
                    document.getElementById('modal-ticket-id').textContent = ticket.id;
                    document.getElementById('modal-ticket-task').textContent = ticket.task;
                    
                    const actionButtons = [
                        { label: "Summarize", prompt: `Summarize the following support ticket task in one concise sentence: "${ticket.task}"` },
                        { label: "Suggest Steps", prompt: `Based on the support ticket with the task "${ticket.task}" and priority "${ticket.priority}", suggest 3 concrete, actionable steps to resolve it. Present them as a numbered list.` },
                        { label: "Draft Reply", prompt: `You are a helpful customer support agent. Draft a professional and empathetic email to the customer regarding their ticket: "${ticket.task}". The ticket status is currently "${ticket.status}". Inform them we are looking into it. Sign off as 'The Support Team'.` }
                    ];

                    const buttonsContainer = document.getElementById('modal-action-buttons');
                    buttonsContainer.innerHTML = '';
                    actionButtons.forEach(action => {
                        const button = document.createElement('button');
                        button.className = 'btn btn-primary flex-grow-1';
                        button.textContent = action.label;
                        button.onclick = () => generateAiContent(action.prompt);
                        buttonsContainer.appendChild(button);
                    });
                    
                    // Reset modal state and show
                    document.getElementById('ai-response-content').innerHTML = "Select an action above to get started...";
                    document.getElementById('ai-loading-spinner').classList.add('d-none');
                    aiModal.show();
                }
            }
        });
        
        // --- GEMINI API FUNCTION ---
        const generateAiContent = async (prompt) => {
            const loadingSpinner = document.getElementById('ai-loading-spinner');
            const responseContent = document.getElementById('ai-response-content');
            
            loadingSpinner.classList.remove('d-none');
            responseContent.innerHTML = '';
            
            // IMPORTANT: Replace with your actual API key for this to work.
            const apiKey = "AIzaSyAsuU51rermC0gMeA_ObsTlCvJdp_LLAi4"; // Or use a secure way to manage your key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                responseContent.textContent = text || "Sorry, I couldn't generate a response.";

            } catch (error) {
                console.error("Gemini API call error:", error);
                responseContent.textContent = `An error occurred: ${error.message}. Make sure you have added a valid API Key in the script.`;
            } finally {
                loadingSpinner.classList.add('d-none');
            }
        };

        // --- CHARTING ---
        const renderCharts = () => {
            // Get priority counts
            const priorityCounts = calculatePriorityCounts();
            const highPriority = priorityCounts.High;
            const mediumPriority = priorityCounts.Medium;
            const lowPriority = priorityCounts.Low;

             // Weekly Trends Bar Chart (mock data for now, as no date field in DB)
            const weeklyCtx = document.getElementById('weeklyTrendsChart').getContext('2d');
            new Chart(weeklyCtx, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Tickets',
                        // You'll need actual date-based data from your DB for a real trend chart
                        data: [12, 19, 11, 15, 18, 21, 9], 
                        backgroundColor: 'rgba(75, 102, 255, 0.8)',
                        borderColor: 'rgba(75, 102, 255, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Priority Distribution Doughnut Chart (using real data)
            const priorityCtx = document.getElementById('priorityChart').getContext('2d');
            const priorityData = {
                labels: ['High', 'Medium', 'Low'],
                datasets: [{
                    data: [highPriority, mediumPriority, lowPriority], // Use real counts
                    backgroundColor: ['#dc3545', '#ffc107', '#198754'],
                    hoverOffset: 4
                }]
            };
            new Chart(priorityCtx, {
                type: 'doughnut',
                data: priorityData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: true }
                    }
                }
            });
            // Custom legend for priority chart
            const legendContainer = document.getElementById('priority-legend');
            legendContainer.innerHTML = ''; // Clear previous legend
            priorityData.labels.forEach((label, index) => {
                const color = priorityData.datasets[0].backgroundColor[index];
                const value = priorityData.datasets[0].data[index];
                legendContainer.innerHTML += `
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div class="d-flex align-items-center">
                           <span class="d-inline-block me-2" style="width:12px; height:12px; background-color:${color}; border-radius: 50%;"></span>
                           <span class="small">${label} Priority</span>
                        </div>
                        <span class="small fw-bold">${value}</span>
                    </div>
                `;
            });
        };

        // --- INITIAL RENDER ---
        renderStatCards();
        renderStatusOverview();
        renderCharts();
        // Initially render the table with no filter, or a default filter like 'Open'
        renderTicketTable(); 
    });
    </script>
</body>
</html>